release_update_for_trade_good = {
	REB = {
		set_variable = {
			which = stock_market_supply_for_$trade_good_id$
			value = 0
		}
		set_variable = {
			which = stock_market_demand_for_$trade_good_id$
			value = 0
		}
	}
	
	every_country = {
		limit = {
			NOT = { tag = REB }
		}
		set_variable = {
			which = stock_market_demand_for_$trade_good_id$
			value = 0
		}
		set_variable = {
			which = stock_market_supply_for_$trade_good_id$
			value = 0
		}
		export_to_variable = {
			variable_name = temp_global_trade_goods_size_modifier
			value = modifier:global_trade_goods_size_modifier
			who = ROOT
		}
		export_to_variable = {
			variable_name = temp_global_trade_goods_size
			value = modifier:global_trade_goods_size
			who = ROOT
		}
		every_owned_province = {
			update_supply_for_trade_good = { trade_good_id = $trade_good_id$ }
			update_demand_for_trade_good = { trade_good_id = $trade_good_id$ }
		}
		
		update_national_supply_for_trade_good = { trade_good_id = $trade_good_id$ }
		update_national_demand_for_trade_good = { trade_good_id = $trade_good_id$ }
		
		REB = {
			change_variable = {
				which = stock_market_supply_for_$trade_good_id$
				which = PREV
			}
			change_variable = {
				which = stock_market_demand_for_$trade_good_id$
				which = PREV
			}
		}
	}
	
	set_price_for_trade_good = { trade_good_id = $trade_good_id$ }
}

update_supply_for_trade_good = {
	set_variable = {
		which = tempvar
		value = $trade_good_id$
	}
	if = {
		limit = {
			is_variable_equal = {
				which = stock_market_good_index
				which = tempvar
			}
		}
		owner = {
			export_to_variable = {
				variable_name = tempvar
				value = modifier:trade_goods_size
				who = PREV
			}
			export_to_variable = {
				variable_name = tempvar2
				value = modifier:trade_goods_size_modifier
				who = PREV
			}
			change_variable = {
				which = tempvar
				which = temp_global_trade_goods_size
			}
			change_variable = {
				which = tempvar2
				which = temp_global_trade_goods_size_modifier
			}
			change_variable = {
				which = tempvar2
				value = 1
			}
			multiply_variable = {
				which = tempvar
				which = tempvar2
			}
			change_variable = {
				which = stock_market_supply_for_$trade_good_id$
				which = tempvar
			}
		}
	}
}

update_national_supply_for_trade_good = {
	update_national_supply_for_trade_good_$trade_good_id$ = yes
}

update_national_demand_for_trade_good = {
	update_national_demand_for_trade_good_$trade_good_id$ = yes
}

update_demand_for_trade_good = {
	update_demand_for_trade_good_$trade_good_id$ = yes
}

stock_market_change_price_with_id = {
	stock_market_change_price_$trade_good_id$ = { value = $value$ }
}

stock_market_change_price = {
	if = {
		limit = {
			is_month = 11
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 31
		}
	}

	else_if = {
		limit = {
			is_month = 10
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}

	else_if = {
		limit = {
			is_month = 9
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}

	else_if = {
		limit = {
			is_month = 8
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 29
		}
	}

	else_if = {
		limit = {
			is_month = 7
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}

	else_if = {
		limit = {
			is_month = 6
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}

	else_if = {
		limit = {
			is_month = 5
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 29
		}
	}
	else_if = {
		limit = {
			is_month = 4
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}

	else_if = {
		limit = {
			is_month = 3
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 29
		}
	}

	else_if = {
		limit = {
			is_month = 2
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}
	else_if = {
		limit = {
			is_month = 1
		}
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 27
		}
	}
	else = { 
		change_price = {
			trade_goods = $trade_goods$
			key = "Current Market Conditions"
			value = $value$
			duration = 30
		}
	}

}

set_price_for_trade_good = {
	 #Assuming we have a way to get the global default price
    REB = {
        set_variable = {
            which = stock_market_price_value_$trade_good_id$
            value = 5
        }

        set_variable = {
            which = difference_value_$trade_good_id$
            which = stock_market_demand_for_$trade_good_id$
        }

        subtract_variable = {
            which = difference_value_$trade_good_id$
            which = stock_market_supply_for_$trade_good_id$
        }


        set_variable = {
            which = sum_value_$trade_good_id$
            which = stock_market_supply_for_$trade_good_id$
        }


        change_variable = {
            which = sum_value_$trade_good_id$
            which = stock_market_demand_for_$trade_good_id$
        }

        set_variable = {
            which = price_multiplier_$trade_good_id$
            which = difference_value_$trade_good_id$
        }


        divide_variable = {
            which = price_multiplier_$trade_good_id$
            which = sum_value_$trade_good_id$
        }

		change_variable = {
            which = price_multiplier_$trade_good_id$
            value = 1
        }

        multiply_variable = {
            which = price_multiplier_$trade_good_id$	
            which = price_multiplier_$trade_good_id$
        }

		subtract_variable = {
            which = price_multiplier_$trade_good_id$
            value = 1
        }
    }
}

stock_market_on_startup = {
	1 = {
		set_province_flag = stock_market_refresh_flag
		add_province_triggered_modifier = stock_market_refresh_prices_bimonthly
	}
	priority_update = yes
}

priority_update = {
	release_update_for_trade_good = { trade_good_id = 3 } #cloth
	release_update_for_trade_good = { trade_good_id = 2 } #wool (we need cloth supply to determine supply) 
	
	release_update_for_trade_good = { trade_good_id = 1 } #wool
	release_update_for_trade_good = { trade_good_id = 0 } #grain
}